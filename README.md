# Neoxa Masternode Setup
This is a guide to setup a server for neoxa masternodes, it sets up a reasonably secure server with cockpit for management and podman for running containers

## Requirements for this setup
- Server running Rocky Linux 9.2 or Alma Linux 9.2 ( Tested on Rocky Linux ) 
- Whenever you see something like {parameter} in the commands you need to substitute it with an actual value for your case

#### Official requirements per node
- 2 vCPU
- 4GB Ram
- 80GB SSD

#### Trust me bro estimate:
- 1 Thread
- 2GB Ram
- 20GB SSD

## 1. After server is provisioned
Login with SSH or any other means, and switch to root user using

    sudo su

Download and execute the install.sh script, **Make sure to substitute {username} and {password} with real values, this user will be the one you use, make sure the password is very strong and preferably generated with a password manager**

    curl -sSL https://raw.githubusercontent.com/ctzoki/neoxa-mn/main/install.sh | bash -s {username} {password}
    
Server will reboot after installation is complete

![command](https://github.com/ctzoki/neoxa-mn/assets/129646348/c7c3a7f6-1ee8-4f8f-a85b-b3c093203dfa)

## 2. Welcome to your new server
Open the cockpit web ui using a browser, don't forget to substitute {ip-of-your-server} with your actual IP 

    https://{ip-of-your-server}:9090
    
![login](https://github.com/ctzoki/neoxa-mn/assets/129646348/26488999-0b70-4963-875c-2252c886eb97)

Click on Limited Access button on the top bar and enter your password again to enable administrative access for your session

![switch](https://github.com/ctzoki/neoxa-mn/assets/129646348/28c8845d-0daf-4438-979b-469077699b1d)

#### 2.1. Install Navigator
Head over to Terminal
Login, and switch to root user using

    sudo su
    
Install Navigator

    dnf install https://github.com/45Drives/cockpit-navigator/releases/download/v0.5.10/cockpit-navigator-0.5.10-1.el8.noarch.rpm

#### 2.2. Accounts setup
Head over to the Accounts menu
- There should be only 2 accounts, the username you provided to the installation script and root user
- If there are additional accounts, sometimes created by server providers, delete them
- Change the root password to a strong secure password generated by you

Before
![accounts-1](https://github.com/ctzoki/neoxa-mn/assets/129646348/b33a0890-e94a-424d-94a6-f308244f9b50)

After
![accounts-2](https://github.com/ctzoki/neoxa-mn/assets/129646348/06a2bf36-1cc5-4fea-8405-6b6dceade377)

#### 2.3. Enable metrics collection
Head over to the Overview menu, on the Usage Panel press "View metrics and history", enable the monitoring and collection services, do not enable "Export to network"

Before
![metrics-1](https://github.com/ctzoki/neoxa-mn/assets/129646348/0c89e60c-9c14-4652-90f0-82efeae78016)

Next Step
![metrics-2](https://github.com/ctzoki/neoxa-mn/assets/129646348/2e9c544e-c341-42b3-ba65-c1afe9872cb3)

It will take some time for data to start showing, check it again later


#### 2.4. Enable automatic updates
Head over to the Software Updates menu, install and enable the "Automatic updates" and "Kernel live patching"

Automatic Updates
![software-updates-1](https://github.com/ctzoki/neoxa-mn/assets/129646348/a4f9c6df-a31f-462d-8b92-dbe8ca10d9b5)

Enable automatic updates
![software-updates-2](https://github.com/ctzoki/neoxa-mn/assets/129646348/4b3ce296-f0db-49e0-af38-9ac3c691142e)

Enable kernel live patch
![software-updates-3](https://github.com/ctzoki/neoxa-mn/assets/129646348/e660f54f-dcfa-47d8-b238-9821ee920cd1)

Final state
![software-updates-4](https://github.com/ctzoki/neoxa-mn/assets/129646348/de55737d-c8e2-4c69-b7bd-fd42917bb782)

#### 2.5. Add additional IPs
Head over to the Networking menu, click on the main interface that is online, usually named eno1/eth1, click edit on the IPV4 settings, now a new popup will appear where you can enter all the additional IPs that you have for running masternodes

![network](https://github.com/ctzoki/neoxa-mn/assets/129646348/567ca22b-c752-4343-ba4e-f304ad975b7d)

#### 2.6. Enable Podman
Head over to the Podman menu, enable the podman service, here we will be starting all the nodes as described in the next section.

![podman](https://github.com/ctzoki/neoxa-mn/assets/129646348/1c33d31a-fb03-43de-bc75-1d8cab63dcb7)

## 3 Running MN Containers in Podman

#### 3.1 Preparing your collateral and registering your masternode
Head over to your neoxa-qt wallet and open the debug console, 4 commands need to be executed to register the masternode

    getnewaddress

It will output a new address with 0 balance, use it for the next command

    sendtoaddress "{your-new-address-here}" {number-of-coins}

You are sending coins to the new address, for testnet use 60000.0 for mainnet use 1000000.0, the output will be the transaction id, take note of it

    smartnode outputs

This will list the transactions which outputs match MN requirements, find the one that matches the previoulsy noted, and take note of the sequecence appearing next to it, i.e. 0 or 1
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/64472eb1-6a03-4545-a8c3-be9e936bbd04)

    listaddressgroupings

This command will output all your wallet addresses, find one with a few neox balance to be used as fee for the next transaction, **!DO NOT USE THE ONE WHERE YOU DEPOSITED COLLATERAL AMOUNT!**
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/959362cc-0aa1-4cff-bdb3-71cc66ec96c8)

    protx quick_setup {your-tx-id} {output-sequence} {your-ip}:{your-port} {your-fee-address}

Substitute all the parameters here with your actual values
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/db2d3076-543f-40f7-a706-dd52e73e73d3)

Thats all of the commands, the last one outputs the path to your configuration file, the file it generates should look similar to the image below, copy the file contents we will need it on the server.
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/18ead970-74c3-480d-9d8d-82ded8cca784)

#### 3.2 Setting up the config on the server
Open the Navigator and navigate to the /opt folder, here we will create the directories for our containers, i suggest creating first folders "testnet" and "mainnet" to have nice structure on your server, then in the testnet or mainnet folder create folders for your nodes, i.e. node-1, node-2, node-x
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/23d3b5e8-fc79-468e-b1b5-00f10179cbcc)

Inside of your node-x folder we will need to create the neoxa.conf file
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/db9af4c8-6829-49c3-8279-6fc0ee7fa2e9)

Then edit it by double clicking it to enter your generated neoxa.conf, **ADD testnet=1 AT THE END OF THE CONFIG IF YOU WANT TESTNET**
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/f4667c37-e343-49d3-ab7c-2832e0a133b1)

As a last step we need to setup correct permissions for the container to use the directory, the following commands need to run

    sudo chmod 755 {your-directory-path}

    sudo chown -R 5196:5196 {your-directory-path}

    sudo chcon -R -t container_file_t {your-directory-path}

![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/0fe84d30-cc9b-4e46-b5d0-a8a50acf26ee)

Now all the files and permissions are in place to run the containers

#### 3.3 Creating your pod and your container
Head over to the podman menu and click on create pod, enter your details taking care to enter your correct host path volume, i.e. /opt/testnet/node-x and map it to /var/lib/neoxa, also make sure to enter your correct IP and Port
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/afac9d3b-4640-41ad-bc8a-c5628cb91dea)

Then click on "Create container in pod" in the pod that you just created, use image **ctzoki/neoxa-full-node** to run your node with, the other parameters are not mandatory but its recommended to set up like in the image below
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/4b94cd6a-b401-4633-96d7-10532ef3968b)
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/5b539e59-613f-4bf8-81fa-57fb45ac0c0f)

Double check the integrations tab that everything is mapped as needed
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/b3c9a84e-dedc-4740-aa18-518abed15d04)

Check the logs are printing ok, if there is a problem in the config you will notice it in the logs
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/9b0280f6-7e61-4bda-9101-cf39b1d51b9d)

## 4 Optional

#### 4.1 Smartnode Status Page
A status page is available and can be installed by running the following command in the terminal

    sudo curl -sSL https://raw.githubusercontent.com/ctzoki/neoxa-mn/main/install-smartnode-status.sh | sudo bash

The smartnode status will appear as Red if there is penalty to your node, Gray if other issue is found and Green if all ok, image below for demonstration

![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/56f06b3b-6019-44d9-b453-37e62c96381a)

#### 4.2 NAT Reflection
If you are running your nodes behind a NAT, i.e. port forwarding from your home router you probably don't have NAT reflection, its the ability to connect to your public IP from within your network, you can install the following tool to help with that 

    sudo curl -sSL https://raw.githubusercontent.com/ctzoki/neoxa-mn/main/install-nat-reflection.sh | sudo bash

the tool supports 4 commands, add, list, reload, delete, add and delete take in two parameters public ip and private ip, run the add command to enable reflection for an ip

    sudo nat-reflection add {your-public-ip} {your-local-ip}

Add a reflection

    sudo nat-reflection list

List all reflections

    sudo nat-reflection reload

Reload, mostly used by the service on startup

    sudo nat-reflection delete {your-public-ip} {your-local-ip}

Delete a reflection, if you made a mistake or don't need it anymore
![image](https://github.com/ctzoki/neoxa-mn/assets/129646348/2682ee61-05af-4048-8e29-2de63bec2534)
